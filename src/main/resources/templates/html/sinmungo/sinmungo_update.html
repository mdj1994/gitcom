<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<th:block layout:fragment="contentFragment">
    <div id="body_container">
        <div class="body_inner">
            <div class="sub01_write">
                <h3 class="subTitle">글쓰기</h3>
                <div class="tbl_write">
                    <table>
                        <colgroup>
                            <col style="width: 10%">
                            <col style="width: 40%">
                            <col style="width: 10%">
                            <col style="width: 40%">
                        </colgroup>
                        <tbody>
                        <tr>
                            <th scope="row">*지부선택</th>
                            <td>
                                <select class="selectType" id="branch_option">
                                    <!--                      <option>JS 에서 호출</option>-->
                                </select>
                            </td>
                            <th class="psw">비밀번호</th>
                            <td><label><input type="checkbox" id="ckbox"> <span id="checkcontent">비공개여부</span></label>
                                <input type="text" class="inputType" id="note_passwd" placeholder="비밀번호를 입력해주세요."
                                       style="width: 180px;display:none;"></td>
                        </tr>
                        <tr>
                            <th scope="row">*제목</th>
                            <td colspan="3"><input type="text" class="inputType" id='note_title'
                                                   placeholder="제목을 입력하세요.(30자 이내)" style="width: 99%;"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="content">*내용</th>
                            <td colspan="3"><textarea id='note_contents' placeholder="내용을 입력하세요.(3000자 이내)" rows="10"
                                                      cols="10"></textarea></td>
                        </tr>
                        <tr>
                            <th scope="row">첨부파일</th>
                            <td colspan="3">
                                <label class="fileEntry"><input type="file"><span>파일찾기</span></label>
                                <div class="fileList">
                                    <a href="#" class="file">[건설협회] 교육 운영자료.hwp</a><a href="#" class="btn_del">삭제</a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="btn_area">
                    <div class="btn_left"><a th:href="@{/sinmungo/sinmungo_list.do}" class="btn_list">목록</a></div>
                    <div class="btn_right">
                        <a th:href="@{/sinmungo/sinmungo_list.do}" class="btn_cancel">취소</a>
                        <a class="btn_done" id="btn_result">수정완료</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- s: 제목 글자수 조절 -->
    <div class="popup_wrap" style="display:none;" id="popup_title">
        <div class="msgPopup_wrap">
            <h2 class="pHeader">알림</h2>
            <div class="pBody">
                <p class="msg01">제목이 30자가 넘습니다.</p>
                <button type="button" class="btn_type01" id="p_title_close">다시시도</button>
            </div>
        </div>
    </div>
    <!-- e: popup -->

    <!-- s: 내용 글자수 조절 -->
    <div class="popup_wrap" style="display:none;" id="popup_content">
        <div class="msgPopup_wrap">
            <h2 class="pHeader">알림</h2>
            <div class="pBody">
                <p class="msg01">내용이 1000자가 넘습니다.</p>
                <button type="button" class="btn_type01" id="p_content_close">다시시도</button>
            </div>
        </div>
    </div>
    <!-- e: popup -->


    <!-- 비밀글 열었을 경우 popup창 생성 -->
    <!-- s: pwd -->
    <div class="popup_wrap" style="display:none;" id="popup_secret">
        <div class="msgPopup_wrap">
            <h2 class="pHeader">알림</h2>
            <div class="pBody">
                <div class="pwdEntry">
                    <p>비밀번호를 입력해주세요.</p>
                    <input type="text" class="entry" id="secrit_text"/>
                </div>
                <button type="button" class="btn_type01" id="btn_pop_result">확인</button>
            </div>
        </div>
    </div>
    <!-- e: pwd -->



<script layout:fragment="javascript" th:inline="javascript">

    const APIURL = [[${@environment.getProperty('API_SERVER')}]];
    const WEBURL = [[${@environment.getProperty('WEB_SERVER')}]];
    let passwd = '';

    //제일 처음 실행
    $(document).ready(function() {

        passwd = [[${session?.last_passwd}]];

        //공백일 경우, url로 호출 한 경우.
        if(passwd == null || passwd == '0') {


            /* 공개글 / 비공개글 유무 파악 */
            //html문구에서 값 수정으로 비밀글 공유 문제 해결.
            //url로 값 추출 문제 해결
            const URL = APIURL + '/user/sinmungo/sinmungo_secrit.ajax';

            let data = new FormData;
            data.append("sinmungo_no", [[${idx}]]);


            $.ajax({
                url : URL,
                type : 'post',
                data : data,
                dataType : 'json',
                contentType : false,
                processData : false,
                success :function(data) {
                    console.log(data);
                    if(data.RST_CD == 0) {
                        detail_show(); //상세 보기
                    }
                    else if(data.RST_CD == '-2') {
                        $('#popup_secret').show();
                    }
                },
                error : function(request, status, error) {
                    console.log("code : "+request.status+"\nmessage : "+request.responseText+"\nerror : "+error);
                }
            });
        }
        else {
            detail_show(); //상세 보기
        }


    });

    $('#btn_pop_result').click(function() {
        passwd = $('#secrit_text').val(); //popup 창 입력값 가져오기
        $('#popup_secret').hide();

        detail_show();
    });

    //상세보기
    function detail_show() {
        const URL = APIURL+'/user/sinmungo/sinmungo_detail.ajax';

        let idx = [[${idx}]];

        let data = new FormData;
        data.append("sinmungo_no", idx);
        data.append("publish_passwd", passwd);

        let id_check = [[${session?.member?.member_no}]];
        if(id_check != null) {
            data.append("no", id_check);
        }

        $.ajax({
            url : URL,
            data : data,
            type : 'post',
            dataType : 'json',
            contentType: false,
            processData: false,
            success : function(data) {
                console.log(data);
                if(data.RST_CD == 0) {
                    let result = data.result;
                    $('#note_no').val(result.sinmungo_no);
                    $('#note_title').val(result.title);
                    $('#note_contents').val(result.contents);
                    $('#note_nm').val(result.member_nm);
                    $('#note_date').val(result.reg_date);
                    if(passwd != '0') {
                        $('#note_passwd').val(passwd);
                    }
                    branch_list(result.sinmungo_branch_no);

                    if(data.id_check == 1) {
                        $('#btn_update').show();
                    } else if(data.id_check == 2) {
                        $('#btn_good').show();
                    }
                }

                else if(data.RST_CD == '-2') {
                    location.href=[[@{/sinmungo/sinmungo_list.do}]];
                }
            },
            error: function (request, status, error) {
                console.log("code : " + request.status + "\nmessage : " + request.responseText + "\nerror : " + error);
            }
        });
    }


    function branch_list(value) {
        const URL = APIURL + '/user/branch/branch_list.ajax';

        $.ajax({
            url: URL,
            type: 'post',
            dataType: 'json',
            success: function (data) {
                console.log(data);
                if (data.RST_CD == 0) {
                    let option = '';
                    for (var i = 0; i < data.list.length; i++) {
                        option += '<option value=' + data.list[i].branch_no + '>' + data.list[i].branch_nm + '</option>';
                    }

                    $('#branch_option').html(option);
                    $('#branch_option').val(value);
                }
                //
            },
            error: function (request, status, error) {
                console.log("code : " + request.status + "\nmessage : " + request.responseText + "\nerror : " + error);
            }
        });
    }

    <!-- 작성 완료 클릭 -->
    $('#btn_result').click(function () {


        //유효성 검사
        if (!($('#note_title').val().length < 30)) {
            $('#popup_title').show();
            return;
        }
        if (!($('#note_contents').val().length < 1000)) {
            $('#popup_contents').show();
            return;
        }

        passwd = $('#note_passwd').val();
        const idx = [[${idx}]];     //게시글 번호

        //data 저장하기
        var data = new FormData();
        data.append("sinmungo_no",idx);            //게시글 번호
        data.append("title", $('#note_title').val());         //제목
        data.append("contents", $('#note_contents').val());    //내용
        data.append("sinmungo_branch_no", $('#branch_option').val());  //지점번호
        data.append("reg_member_no", [[${session.member.member_no}]]);  //현재 로그인 되어 있는 계정 정보
        data.append("publish_passwd", passwd);         //현재 글, 비밀번호 여부


        const URL = APIURL + '/user/sinmungo/sinmungo_update.ajax';

        $.ajax({
            url: URL,
            type: 'post',
            data: data,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (data) {
                if(data.RST_CD == 0) {

                    if(passwd != '') {
                        location.href = [[@{/sinmungo/sinmungo_secrit_detail.do}]]+'?idx='+idx+'&secrit='+passwd;
                    }
                    else {
                        passwd = 0;
                        location.href = [[@{/sinmungo/sinmungo_secrit_detail.do}]]+'?idx='+idx+'&secrit='+passwd;
                    }
                }
            },
            error: function (request, status, error) {
                alert("code : " + request.status + "\nmessage : " + request.responseText + "\nerror : " + error);
            }
        })

    })

    //popup 닫기
    //title 영역
    $('#p_title_close').click(function () {
        $('#popup_title').hide()
    });

    //content 영역
    $('#p_content_close').click(function () {
        $('#popup_content').hide()
    });


    //비공개여부 checkbox
    $('#ckbox').click(function() {

        //on 할 경우
        if($('#ckbox').is(':checked')) {
            $('#checkcontent').hide();
            $('#note_passwd').show();
        }
        //off 할 경우
        else {
            $('#checkcontent').show();
            $('#note_passwd').val('');
            $('#note_passwd').hide();
        }
    });
</script>
</html>